<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Integrity Monitor - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 14px;
        }

        .auth-section {
            background: #fff;
            padding: 40px;
            border-radius: 8px;
            max-width: 400px;
            margin: 100px auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }

        input[type="text"],
        input[type="password"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #dfe6e9;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        button:hover {
            background: #2980b9;
        }

        button.secondary {
            background: #95a5a6;
        }

        button.secondary:hover {
            background: #7f8c8d;
        }

        button.danger {
            background: #e74c3c;
        }

        button.danger:hover {
            background: #c0392b;
        }

        button.success {
            background: #27ae60;
        }

        button.success:hover {
            background: #229954;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #7f8c8d;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .content-section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        .content-section.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge.pending {
            background: #ffeaa7;
            color: #d63031;
        }

        .badge.approved {
            background: #d4edda;
            color: #155724;
        }

        .badge.rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .badge.high {
            background: #f8d7da;
            color: #721c24;
        }

        .badge.medium {
            background: #fff3cd;
            color: #856404;
        }

        .badge.low {
            background: #d1ecf1;
            color: #0c5460;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-buttons button {
            font-size: 12px;
            padding: 6px 12px;
        }

        .code-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .info-label {
            font-weight: 600;
            color: #7f8c8d;
        }

        .logout-btn {
            float: right;
        }

        /* Small button styles for user management */
        button.small {
            padding: 6px 12px;
            font-size: 12px;
            margin: 2px;
        }
    </style>
</head>
<body>
    <!-- Authentication Section -->
    <div id="authSection" class="auth-section">
        <!-- Login Form -->
        <div id="loginForm">
            <h2 style="margin-bottom: 20px;">Admin Login</h2>
            <div id="authError" class="error-message" style="display:none;"></div>

            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Enter your username" autocomplete="username">
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password" autocomplete="current-password">
            </div>

            <button id="loginButton" style="width: 100%;">Login</button>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ecf0f1;">
                <p style="font-size: 12px; color: #7f8c8d; margin-bottom: 10px;">
                    <strong>Default Credentials:</strong><br>
                    Username: admin<br>
                    Password: admin123
                </p>
                <p style="font-size: 11px; color: #95a5a6;">
                    <em>MFA is optional. Set it up after login for enhanced security.</em>
                </p>
            </div>
        </div>

        <!-- MFA Verification Form (hidden initially) -->
        <div id="mfaForm" style="display: none;">
            <h2 style="margin-bottom: 20px;">Two-Factor Authentication</h2>
            <div id="mfaError" class="error-message" style="display:none;"></div>

            <p style="margin-bottom: 20px; color: #7f8c8d;">
                Enter the 6-digit code from your authenticator app
            </p>

            <div class="form-group">
                <label for="mfaCode">Verification Code</label>
                <input type="text" id="mfaCode" placeholder="000000" maxlength="6" pattern="[0-9]*" inputmode="numeric" style="font-size: 24px; text-align: center; letter-spacing: 8px;">
            </div>

            <button onclick="verifyMFA()" style="width: 100%; margin-bottom: 10px;">Verify</button>

            <div style="text-align: center; margin-top: 15px;">
                <a href="#" onclick="showBackupCodeInput(); return false;" style="font-size: 13px; color: #3498db; text-decoration: none;">
                    Use backup code instead
                </a>
            </div>

            <div id="backupCodeInput" style="display: none; margin-top: 15px;">
                <div class="form-group">
                    <label for="backupCode">Backup Code</label>
                    <input type="text" id="backupCode" placeholder="Enter backup code" style="text-transform: uppercase;">
                </div>
                <button onclick="verifyBackupCode()" style="width: 100%;">Verify Backup Code</button>
            </div>

            <button onclick="cancelMFA()" class="secondary" style="width: 100%; margin-top: 10px;">Cancel</button>
        </div>
    </div>

    <!-- Main Dashboard (hidden until authenticated) -->
    <div id="mainDashboard" style="display: none;">
        <div class="container">
            <header>
                <h1>Script Integrity Monitor</h1>
                <p class="subtitle">PCI DSS v4.0 Requirement 6.4.3 Compliance Dashboard</p>
                <button class="logout-btn secondary" onclick="logout()">Logout</button>
            </header>

            <!-- Statistics Dashboard -->
            <div class="dashboard" id="statsContainer">
                <div class="stat-card">
                    <h3>Total Scripts</h3>
                    <div class="stat-value" id="totalScripts">-</div>
                </div>
                <div class="stat-card">
                    <h3>Pending Approval</h3>
                    <div class="stat-value" id="pendingScripts" style="color: #f39c12;">-</div>
                </div>
                <div class="stat-card">
                    <h3>Approved Scripts</h3>
                    <div class="stat-value" id="approvedScripts" style="color: #27ae60;">-</div>
                </div>
                <div class="stat-card">
                    <h3>Violations</h3>
                    <div class="stat-value" id="totalViolations" style="color: #e74c3c;">-</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('inventory', this)">Script Inventory</button>
                <button class="tab" onclick="showTab('pending', this)">Pending Approvals</button>
                <button class="tab" onclick="showTab('violations', this)">Violations</button>
                <button class="tab" onclick="showTab('security', this)">Security Settings</button>
                <button class="tab" onclick="showTab('users', this)">User Management</button>
            </div>

            <!-- Pending Approvals Tab -->
            <div id="pending" class="content-section">
                <h2 style="margin-bottom: 20px;">Scripts Pending Approval</h2>
                <div id="pendingContent" class="loading">Loading...</div>
            </div>

            <!-- Violations Tab -->
            <div id="violations" class="content-section">
                <h2 style="margin-bottom: 20px;">Integrity Violations</h2>
                <div id="violationsContent" class="loading">Loading...</div>
            </div>

            <!-- Inventory Tab -->
            <div id="inventory" class="content-section active">
                <h2 style="margin-bottom: 20px;">Script Inventory</h2>
                <div class="filter-bar" style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="searchQuery" placeholder="Search by URL or content..." style="flex-grow: 1;">
                    <select id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="pending_approval">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                        <option value="flagged">Flagged</option>
                    </select>
                    <select id="typeFilter">
                        <option value="">All Types</option>
                        <option value="inline">Inline</option>
                        <option value="external">External</option>
                    </select>
                    <button onclick="searchInventory()">Search</button>
                </div>
                <div id="inventoryContent" class="loading">Loading...</div>
            </div>

            <!-- Security Settings Tab -->
            <div id="security" class="content-section">
                <h2 style="margin-bottom: 20px;">Security Settings</h2>
                <div id="securityContent">
                    <div style="max-width: 600px;">
                        <!-- MFA Status Section -->
                        <div style="background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ecf0f1;">
                            <h3 style="margin-bottom: 15px; color: #2c3e50;">Two-Factor Authentication (MFA)</h3>
                            <p style="color: #7f8c8d; margin-bottom: 20px;">
                                Add an extra layer of security to your account by requiring a verification code from your authenticator app when you log in.
                            </p>

                            <div id="mfaStatus" style="padding: 15px; background: #f8f9fa; border-radius: 4px; margin-bottom: 15px;">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div>
                                        <strong>Status:</strong> <span id="mfaStatusText">Loading...</span>
                                    </div>
                                    <div id="mfaStatusBadge"></div>
                                </div>
                            </div>

                            <div id="mfaActions">
                                <button id="enableMfaBtn" onclick="startMfaSetup()" class="success" style="display: none;">
                                    Enable Two-Factor Authentication
                                </button>
                                <button id="disableMfaBtn" onclick="disableMfa()" class="danger" style="display: none;">
                                    Disable Two-Factor Authentication
                                </button>
                            </div>

                            <div id="mfaSetupError" class="error-message" style="display:none; margin-top: 15px;"></div>
                            <div id="mfaSetupSuccess" class="success-message" style="display:none; margin-top: 15px;"></div>
                        </div>

                        <!-- Account Information -->
                        <div style="background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #ecf0f1;">
                            <h3 style="margin-bottom: 15px; color: #2c3e50;">Account Information</h3>
                            <div class="info-grid">
                                <div class="info-label">Username:</div>
                                <div id="accountUsername">-</div>
                                <div class="info-label">Email:</div>
                                <div id="accountEmail">-</div>
                                <div class="info-label">Role:</div>
                                <div id="accountRole">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management Tab -->
            <div id="users" class="content-section">
                <h2 style="margin-bottom: 20px;">User Management</h2>
                <div style="margin-bottom: 20px;">
                    <button class="success" onclick="openUserModal()">Add New User</button>
                </div>
                <div id="usersContent">
                    <!-- User table will be rendered here -->
                </div>
            </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userModalTitle">Add New User</h2>
            </div>
            <div id="userError" class="error-message" style="display:none;"></div>
            <div class="form-group">
                <label for="userUsername">Username *</label>
                <input type="text" id="userUsername" required>
            </div>
            <div class="form-group">
                <label for="userEmail">Email *</label>
                <input type="email" id="userEmail" required>
            </div>
            <div class="form-group">
                <label for="userPassword">Password (leave blank to keep unchanged)</label>
                <input type="password" id="userPassword">
            </div>
            <div class="form-group">
                <label for="userRole">Role</label>
                <select id="userRole">
                    <option value="viewer">Viewer</option>
                    <option value="reviewer">Reviewer</option>
                    <option value="admin">Admin</option>
                    <option value="super_admin">Super Admin</option>
                </select>
            </div>
            <div class="form-group">
                <label for="userIsActive">Status</label>
                <select id="userIsActive">
                    <option value="1">Active</option>
                    <option value="0">Inactive</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="success" onclick="saveUser()">Save</button>
                <button class="secondary" onclick="closeUserModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- MFA Setup Modal -->
    <div id="mfaSetupModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Enable Two-Factor Authentication</h2>
            </div>
            <div id="mfaSetupModalError" class="error-message" style="display:none;"></div>

            <div id="mfaSetupStep1" style="display: none;">
                <p style="margin-bottom: 20px; color: #7f8c8d;">
                    Scan this QR code with your authenticator app (Google Authenticator, Authy, 1Password, etc.)
                </p>

                <div style="text-align: center; margin: 20px 0;">
                    <img id="mfaQrCode" src="" alt="QR Code" style="max-width: 250px; border: 1px solid #ecf0f1; padding: 10px; border-radius: 8px;">
                </div>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 20px 0;">
                    <p style="font-size: 12px; color: #7f8c8d; margin-bottom: 5px;"><strong>Manual Entry Key:</strong></p>
                    <p id="mfaSecretKey" style="font-family: monospace; font-size: 14px; word-break: break-all; color: #2c3e50;">-</p>
                </div>

                <div class="form-group">
                    <label for="mfaVerificationCode">Enter the 6-digit code to verify</label>
                    <input type="text" id="mfaVerificationCode" placeholder="000000" maxlength="6" pattern="[0-9]*" inputmode="numeric" style="font-size: 24px; text-align: center; letter-spacing: 8px;">
                </div>

                <div class="modal-actions">
                    <button class="success" onclick="verifyMfaSetup()">Verify & Enable</button>
                    <button class="secondary" onclick="closeMfaSetupModal()">Cancel</button>
                </div>
            </div>

            <div id="mfaSetupStep2" style="display: none;">
                <div class="success-message" style="display: block; margin-bottom: 20px;">
                    Two-Factor Authentication has been enabled successfully!
                </div>

                <p style="margin-bottom: 15px; color: #2c3e50; font-weight: 500;">
                    Save these backup codes in a secure location. You can use them to access your account if you lose your authenticator device.
                </p>

                <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    <p style="font-size: 12px; color: #856404; margin-bottom: 10px;">
                        <strong>⚠️ Important:</strong> Each backup code can only be used once. Store them securely!
                    </p>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 4px; margin-bottom: 20px;">
                    <div id="backupCodesList" style="font-family: monospace; font-size: 14px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <!-- Backup codes will be inserted here -->
                    </div>
                </div>

                <div style="text-align: center;">
                    <button onclick="copyBackupCodes()" class="secondary" style="margin-right: 10px;">Copy to Clipboard</button>
                    <button onclick="closeMfaSetupModal()" class="success">Done</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Approval Modal -->
    <div id="approvalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Approve Script</h2>
            </div>
            <div id="approvalError" class="error-message" style="display:none;"></div>
            <div class="info-grid">
                <div class="info-label">URL:</div>
                <div id="modalUrl" style="word-break: break-all;"></div>
                <div class="info-label">Hash:</div>
                <div id="modalHash" style="font-family: monospace; font-size: 12px; word-break: break-all;"></div>
                <div class="info-label">Type:</div>
                <div id="modalType"></div>
                <div class="info-label">First Seen:</div>
                <div id="modalFirstSeen"></div>
            </div>
            <div class="form-group">
                <label for="businessJustification">Business Justification *</label>
                <textarea id="businessJustification" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label for="scriptPurpose">Script Purpose *</label>
                <input type="text" id="scriptPurpose" required>
            </div>
            <div class="form-group">
                <label for="scriptOwner">Script Owner</label>
                <input type="text" id="scriptOwner">
            </div>
            <div class="form-group">
                <label for="riskLevel">Risk Level</label>
                <select id="riskLevel">
                    <option value="">None</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="critical">Critical</option>
                </select>
            </div>
            <div class="form-group">
                <label for="approvalNotes">Notes</label>
                <textarea id="approvalNotes" rows="3"></textarea>
            </div>
            <div class="modal-actions">
                <button class="success" onclick="submitApproval()">Approve</button>
                <button class="secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Rejection Modal -->
    <div id="rejectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reject Script</h2>
            </div>
            <div id="rejectionError" class="error-message" style="display:none;"></div>
            <div class="info-grid">
                <div class="info-label">URL:</div>
                <div id="rejectModalUrl" style="word-break: break-all;"></div>
            </div>
            <div class="form-group">
                <label for="rejectionReason">Rejection Reason *</label>
                <textarea id="rejectionReason" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label for="rejectionRiskLevel">Risk Level</label>
                <select id="rejectionRiskLevel">
                    <option value="">None</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="critical">Critical</option>
                </select>
            </div>
            <div class="form-group">
                <label for="rejectionNotes">Notes</label>
                <textarea id="rejectionNotes" rows="3"></textarea>
            </div>
            <div class="modal-actions">
                <button class="danger" onclick="submitRejection()">Reject</button>
                <button class="secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Script Details Modal -->
    <div id="scriptDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Script Details</h2>
            </div>
            <div id="scriptDetailsError" class="error-message" style="display:none;"></div>
            <div id="scriptDetailsContent"></div>
            <div class="modal-actions" style="margin-top: 20px;">
                <button id="editScriptBtn" class="success" onclick="toggleEditMode()" style="display: none;">Edit</button>
                <button id="saveScriptBtn" class="success" onclick="saveScriptChanges()" style="display: none;">Save Changes</button>
                <button id="cancelEditBtn" class="secondary" onclick="cancelEdit()" style="display: none;">Cancel</button>
                <button id="closeDetailsBtn" class="secondary" onclick="closeScriptDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin;
        let authToken = localStorage.getItem('jwt_token');
        let refreshToken = localStorage.getItem('refresh_token');
        let tempMFAToken = null;
        let currentScript = null;
        let currentScriptDetails = null;
        let isEditMode = false;
        let currentUser = null;

        // Authentication - Login with username/password
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showError('authError', 'Please enter both username and password');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/admin/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Login failed');
                }

                const data = await response.json();

                if (data.mfaRequired) {
                    // MFA is enabled - show MFA form
                    tempMFAToken = data.tempToken;
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('mfaForm').style.display = 'block';
                    document.getElementById('mfaCode').focus();
                } else {
                    // No MFA - proceed with login
                    completeLogin(data);
                }

            } catch (error) {
                console.error('Login error:', error);
                showError('authError', error.message);
            }
        }

        // MFA Verification
        async function verifyMFA() {
            const mfaCode = document.getElementById('mfaCode').value.trim();

            if (!mfaCode || mfaCode.length !== 6) {
                showError('mfaError', 'Please enter a valid 6-digit code');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/admin/auth/verify-mfa`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tempToken: tempMFAToken,
                        mfaCode: mfaCode,
                        useBackupCode: false
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'MFA verification failed');
                }

                const data = await response.json();
                completeLogin(data);

            } catch (error) {
                console.error('MFA verification error:', error);
                showError('mfaError', error.message);
                document.getElementById('mfaCode').value = '';
            }
        }

        // Verify Backup Code
        async function verifyBackupCode() {
            const backupCode = document.getElementById('backupCode').value.trim().toUpperCase();

            if (!backupCode) {
                showError('mfaError', 'Please enter a backup code');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/admin/auth/verify-mfa`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tempToken: tempMFAToken,
                        mfaCode: backupCode,
                        useBackupCode: true
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Backup code verification failed');
                }

                const data = await response.json();
                completeLogin(data);

            } catch (error) {
                console.error('Backup code verification error:', error);
                showError('mfaError', error.message);
            }
        }

        // Complete login after authentication
        function completeLogin(data) {
            authToken = data.accessToken;
            refreshToken = data.refreshToken;
            currentUser = data.admin;

            // Store tokens
            localStorage.setItem('jwt_token', authToken);
            localStorage.setItem('refresh_token', refreshToken);
            localStorage.setItem('current_user', JSON.stringify(currentUser));

            // Hide auth forms
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('mfaForm').style.display = 'none';

            // Show dashboard
            document.getElementById('mainDashboard').style.display = 'block';

            // Clear form fields
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('mfaCode').value = '';
            tempMFAToken = null;

            // Load data
            loadData();

            console.log('Login successful:', currentUser.username);
        }

        // Cancel MFA
        function cancelMFA() {
            tempMFAToken = null;
            document.getElementById('mfaForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('mfaCode').value = '';
            document.getElementById('backupCode').value = '';
            document.getElementById('backupCodeInput').style.display = 'none';
        }

        // Show backup code input
        function showBackupCodeInput() {
            document.getElementById('backupCodeInput').style.display = 'block';
            document.getElementById('backupCode').focus();
        }

        // Logout
        async function logout() {
            try {
                if (authToken) {
                    await fetch(`${API_BASE}/api/admin/auth/logout`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                }
            } catch (error) {
                console.error('Logout error:', error);
            }

            // Clear tokens and state
            authToken = null;
            refreshToken = null;
            currentUser = null;
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('current_user');

            // Show login form
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('mainDashboard').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('mfaForm').style.display = 'none';
        }

        // API Calls with automatic token refresh
        async function apiCall(endpoint, options = {}, retryCount = 0) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                    ...options.headers
                }
            });

            if (response.status === 401) {
                const error = await response.json();

                // Try to refresh token if expired
                if (error.code === 'TOKEN_EXPIRED' && refreshToken && retryCount === 0) {
                    console.log('Token expired, attempting refresh...');
                    const refreshed = await refreshAccessToken();
                    if (refreshed) {
                        // Retry the original request with new token
                        return apiCall(endpoint, options, retryCount + 1);
                    }
                }

                // Refresh failed or no refresh token - logout
                logout();
                throw new Error('Authentication required');
            }

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Request failed');
            }

            return response.json();
        }

        // Refresh Access Token
        async function refreshAccessToken() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/auth/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken })
                });

                if (!response.ok) {
                    throw new Error('Token refresh failed');
                }

                const data = await response.json();
                authToken = data.accessToken;
                localStorage.setItem('jwt_token', authToken);

                console.log('Token refreshed successfully');
                return true;

            } catch (error) {
                console.error('Token refresh error:', error);
                return false;
            }
        }

        // Data Loading
        async function fetchDashboard() {
            const data = await apiCall('/api/admin/dashboard');

            document.getElementById('totalScripts').textContent = data.compliance?.total_scripts || 0;
            document.getElementById('pendingScripts').textContent = data.compliance?.pending_scripts || 0;
            document.getElementById('approvedScripts').textContent = data.compliance?.approved_scripts || 0;
            document.getElementById('totalViolations').textContent = data.violations?.total_violations || 0;
        }

        async function fetchPendingScripts() {
            const data = await apiCall('/api/admin/scripts/pending');
            renderPendingScripts(data.data || []);
        }

        async function fetchViolations() {
            const data = await apiCall('/api/admin/violations');
            renderViolations(data.data || []);
        }

        function searchInventory() {
            fetchInventory();
        }

        async function fetchInventory() {
            const query = document.getElementById('searchQuery')?.value || '';
            const status = document.getElementById('statusFilter')?.value || '';
            const type = document.getElementById('typeFilter')?.value || '';

            const params = new URLSearchParams();
            if (query) params.append('q', query);
            if (status) params.append('status', status);
            if (type) params.append('type', type);
            params.append('limit', '100');

            const data = await apiCall(`/api/admin/scripts/search?${params.toString()}`);
            renderInventory(data.data || []);
        }

        function renderPendingScripts(scripts) {
            const container = document.getElementById('pendingContent');

            if (scripts.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No pending approvals</h3><p>All scripts have been reviewed</p></div>';
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>URL</th>
                            <th>Type</th>
                            <th>First Seen</th>
                            <th>Page</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${scripts.map(script => `
                            <tr>
                                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${script.url}</td>
                                <td><span class="badge">${script.script_type}</span></td>
                                <td>${new Date(script.first_seen).toLocaleString()}</td>
                                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${script.page_url}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="success" data-script-id="${script.id}" data-script-url="${escapeHtml(script.url)}" data-script-hash="${script.content_hash}" data-script-type="${script.script_type}" data-script-first-seen="${script.first_seen}" onclick="openApprovalModalFromButton(this)">Approve</button>
                                        <button class="danger" data-script-id="${script.id}" data-script-url="${escapeHtml(script.url)}" onclick="openRejectionModalFromButton(this)">Reject</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderViolations(violations) {
            const container = document.getElementById('violationsContent');

            if (violations.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No violations</h3><p>System is operating normally</p></div>';
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Script</th>
                            <th>Type</th>
                            <th>Severity</th>
                            <th>Detected</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${violations.map(v => `
                            <tr>
                                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${v.script_url}</td>
                                <td>${v.violation_type}</td>
                                <td><span class="badge ${v.severity?.toLowerCase()}">${v.severity}</span></td>
                                <td>${new Date(v.detected_at).toLocaleString()}</td>
                                <td><span class="badge ${v.review_status}">${v.review_status}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderInventory(scripts) {
            const container = document.getElementById('inventoryContent');

            if (scripts.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No scripts</h3><p>No scripts have been discovered yet</p></div>';
                return;
            }

            const statusColors = {
                'approved': 'approved',
                'pending_approval': 'pending',
                'rejected': 'rejected',
                'flagged': 'pending'
            };

            const statusLabels = {
                'approved': 'Approved',
                'pending_approval': 'Pending',
                'rejected': 'Rejected',
                'flagged': 'Flagged'
            };

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>URL</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Access Count</th>
                            <th>Variation</th>
                            <th>First Seen</th>
                            <th>Approved By</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${scripts.map(script => `
                            <tr onclick="showScriptDetails(${script.id})" style="cursor: pointer;" title="Click to view details">
                                <td>${script.id}</td>
                                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;" title="${escapeHtml(script.url)}">${escapeHtml(script.url)}</td>
                                <td><span class="badge">${script.script_type}</span></td>
                                <td><span class="badge ${statusColors[script.status] || ''}">${statusLabels[script.status] || script.status}</span></td>
                                <td><strong>${script.access_count || 0}</strong></td>
                                <td>${script.is_variation ? `<span class="badge warning" title="Variation #${script.variation_number} of script #${script.parent_script_id}">Var #${script.variation_number}</span>` : '-'}</td>
                                <td>${new Date(script.first_seen).toLocaleString()}</td>
                                <td>${script.approved_by || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 20px; color: #666; font-size: 14px;">
                    Showing ${scripts.length} script${scripts.length !== 1 ? 's' : ''} (Click any row to view details)
                </div>
            `;
        }

        // Modals
        function openApprovalModal(id, url, hash, type, firstSeen) {
            currentScript = id;
            document.getElementById('modalUrl').textContent = url;
            document.getElementById('modalHash').textContent = hash;
            document.getElementById('modalType').textContent = type;
            document.getElementById('modalFirstSeen').textContent = new Date(firstSeen).toLocaleString();

            // Clear form
            document.getElementById('businessJustification').value = '';
            document.getElementById('scriptPurpose').value = '';
            document.getElementById('scriptOwner').value = '';
            document.getElementById('approvalNotes').value = '';
            document.getElementById('approvalError').style.display = 'none';
            
            // Set default risk level to "low"
            document.getElementById('riskLevel').value = 'low';

            document.getElementById('approvalModal').classList.add('active');
        }

        function openApprovalModalFromButton(button) {
            const id = parseInt(button.getAttribute('data-script-id'));
            const url = button.getAttribute('data-script-url');
            const hash = button.getAttribute('data-script-hash');
            const type = button.getAttribute('data-script-type');
            const firstSeen = button.getAttribute('data-script-first-seen');
            openApprovalModal(id, url, hash, type, firstSeen);
        }

        function openRejectionModal(id, url) {
            currentScript = id;
            document.getElementById('rejectModalUrl').textContent = url;

            document.getElementById('rejectionReason').value = '';
            document.getElementById('rejectionNotes').value = '';
            document.getElementById('rejectionError').style.display = 'none';
            
            // Set default risk level to "high"
            document.getElementById('rejectionRiskLevel').value = 'high';

            document.getElementById('rejectionModal').classList.add('active');
        }

        function openRejectionModalFromButton(button) {
            const id = parseInt(button.getAttribute('data-script-id'));
            const url = button.getAttribute('data-script-url');
            openRejectionModal(id, url);
        }

        function closeModal() {
            document.getElementById('approvalModal').classList.remove('active');
            document.getElementById('rejectionModal').classList.remove('active');
            currentScript = null;
        }

        // Script Details Modal
        async function showScriptDetails(scriptId) {
            document.getElementById('scriptDetailsModal').classList.add('active');
            document.getElementById('scriptDetailsContent').innerHTML = '<div class="loading">Loading script details...</div>';
            document.getElementById('scriptDetailsError').style.display = 'none';
            isEditMode = false;

            try {
                const data = await apiCall(`/api/admin/scripts/${scriptId}`);
                const script = data.script;
                const auditLog = data.auditLog || [];

                // Store for editing
                currentScriptDetails = { script, auditLog };

                const statusColors = {
                    'approved': 'success',
                    'pending_approval': 'warning',
                    'rejected': 'danger',
                    'flagged': 'warning'
                };

                const statusLabels = {
                    'approved': 'Approved',
                    'pending_approval': 'Pending Approval',
                    'rejected': 'Rejected',
                    'flagged': 'Flagged'
                };

                document.getElementById('scriptDetailsContent').innerHTML = `
                    <div style="display: grid; gap: 30px;">
                        <!-- Basic Information -->
                        <div>
                            <h3 style="margin-bottom: 15px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">Basic Information</h3>
                            <div class="info-grid">
                                <div class="info-label">ID:</div>
                                <div>${script.id}</div>

                                <div class="info-label">URL:</div>
                                <div style="word-break: break-all;">${escapeHtml(script.url)}</div>

                                <div class="info-label">Type:</div>
                                <div><span class="badge">${script.script_type}</span></div>

                                <div class="info-label">Status:</div>
                                <div><span class="badge ${statusColors[script.status] || ''}">${statusLabels[script.status] || script.status}</span></div>

                                <div class="info-label">Size:</div>
                                <div>${script.size_bytes ? (script.size_bytes / 1024).toFixed(2) + ' KB' : '-'}</div>

                                <div class="info-label">First Seen:</div>
                                <div>${new Date(script.first_seen).toLocaleString()}</div>

                                <div class="info-label">Last Seen:</div>
                                <div>${new Date(script.last_seen).toLocaleString()}</div>

                                <div class="info-label">Access Count:</div>
                                <div><strong style="color: #3498db; font-size: 16px;">${script.access_count || 0}</strong> <span style="color: #7f8c8d; font-size: 12px;">(times loaded)</span></div>

                                ${script.last_accessed ? `
                                <div class="info-label">Last Accessed:</div>
                                <div>${new Date(script.last_accessed).toLocaleString()}</div>
                                ` : ''}

                                ${script.script_type === 'inline' && script.script_position !== null && script.script_position !== undefined ? `
                                <div class="info-label">Script Position:</div>
                                <div>${script.script_position} <span style="color: #7f8c8d; font-size: 12px;">(index in page)</span></div>
                                ` : ''}

                                ${script.is_variation ? `
                                <div class="info-label">Variation:</div>
                                <div>
                                    <span class="badge warning">Variation #${script.variation_number}</span>
                                    <span style="color: #7f8c8d; font-size: 12px;">of <a href="#" onclick="showScriptDetails(${script.parent_script_id}); return false;">Script #${script.parent_script_id}</a></span>
                                </div>
                                ` : ''}

                                ${script.parent_script_id === null && script.variation_number ? `
                                <div class="info-label">Original Script:</div>
                                <div><span class="badge success">Variation #${script.variation_number}</span> <span style="color: #7f8c8d; font-size: 12px;">(parent of variations)</span></div>
                                ` : ''}

                                <div class="info-label">Page URL:</div>
                                <div style="word-break: break-all;">${escapeHtml(script.page_url)}</div>

                                <div class="info-label">Discovery Context:</div>
                                <div style="font-family: monospace; font-size: 12px; word-break: break-all;">${script.discovery_context || '-'}</div>
                            </div>
                        </div>

                        <!-- Hash Information -->
                        <div>
                            <h3 style="margin-bottom: 15px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">Hash Information</h3>
                            <div class="info-grid">
                                <div class="info-label">Content Hash:</div>
                                <div style="font-family: monospace; font-size: 12px; word-break: break-all;">${escapeHtml(script.content_hash)}</div>
                            </div>
                        </div>

                        <!-- Content Preview -->
                        ${script.content_preview ? `
                        <div>
                            <h3 style="margin-bottom: 15px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">Content Preview</h3>
                            <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; max-height: 200px; font-size: 12px;">${escapeHtml(script.content_preview)}</pre>
                        </div>
                        ` : ''}

                        <!-- Approval Information -->
                        ${script.status === 'approved' || script.status === 'rejected' ? `
                        <div>
                            <h3 style="margin-bottom: 15px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">${script.status === 'approved' ? 'Approval' : 'Rejection'} Information</h3>
                            <div class="info-grid">
                                <div class="info-label">${script.status === 'approved' ? 'Approved By' : 'Rejected By'}:</div>
                                <div>${script.approved_by || '-'}</div>

                                <div class="info-label">${script.status === 'approved' ? 'Approved At' : 'Rejected At'}:</div>
                                <div>${script.approved_at ? new Date(script.approved_at).toLocaleString() : '-'}</div>

                                ${script.status === 'approved' ? `
                                <div class="info-label">Business Justification:</div>
                                <div>${script.business_justification || '-'}</div>

                                <div class="info-label">Script Purpose:</div>
                                <div>${script.script_purpose || '-'}</div>

                                <div class="info-label">Script Owner:</div>
                                <div>${script.script_owner || '-'}</div>

                                <div class="info-label">Risk Level:</div>
                                <div>${script.risk_level ? `<span class="badge ${script.risk_level}">${script.risk_level}</span>` : '-'}</div>
                                ` : `
                                <div class="info-label">Rejection Reason:</div>
                                <div>${script.rejection_reason || '-'}</div>
                                `}

                                <div class="info-label">Notes:</div>
                                <div>${script.approval_notes || '-'}</div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Audit Log -->
                        ${auditLog.length > 0 ? `
                        <div>
                            <h3 style="margin-bottom: 15px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">Audit Log</h3>
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Action</th>
                                        <th>Status Change</th>
                                        <th>Performed By</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${auditLog.map(log => `
                                        <tr>
                                            <td><span class="badge">${log.action}</span></td>
                                            <td>${log.previous_status || '-'} → ${log.new_status}</td>
                                            <td>${log.performed_by}</td>
                                            <td>${new Date(log.performed_at).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : ''}
                    </div>
                `;

                // Show edit button
                document.getElementById('editScriptBtn').style.display = 'inline-block';
                document.getElementById('saveScriptBtn').style.display = 'none';
                document.getElementById('cancelEditBtn').style.display = 'none';
                document.getElementById('closeDetailsBtn').style.display = 'inline-block';

            } catch (err) {
                document.getElementById('scriptDetailsContent').innerHTML = `
                    <div class="error-message" style="display: block;">
                        Failed to load script details: ${err.message}
                    </div>
                `;
            }
        }

        function toggleEditMode() {
            isEditMode = true;
            renderEditMode();
        }

        function renderEditMode() {
            if (!currentScriptDetails) return;

            const script = currentScriptDetails.script;

            document.getElementById('scriptDetailsContent').innerHTML = `
                <div style="display: grid; gap: 20px;">
                    <div class="form-group">
                        <label for="editStatus">Status *</label>
                        <select id="editStatus">
                            <option value="pending_approval" ${script.status === 'pending_approval' ? 'selected' : ''}>Pending Approval</option>
                            <option value="approved" ${script.status === 'approved' ? 'selected' : ''}>Approved</option>
                            <option value="rejected" ${script.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                            <option value="flagged" ${script.status === 'flagged' ? 'selected' : ''}>Flagged</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="editBusinessJustification">Business Justification</label>
                        <textarea id="editBusinessJustification" rows="3">${script.business_justification || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label for="editScriptPurpose">Script Purpose</label>
                        <input type="text" id="editScriptPurpose" value="${escapeHtml(script.script_purpose || '')}">
                    </div>

                    <div class="form-group">
                        <label for="editScriptOwner">Script Owner</label>
                        <input type="text" id="editScriptOwner" value="${escapeHtml(script.script_owner || '')}">
                    </div>

                    <div class="form-group">
                        <label for="editRiskLevel">Risk Level</label>
                        <select id="editRiskLevel">
                            <option value="">None</option>
                            <option value="low" ${script.risk_level === 'low' ? 'selected' : ''}>Low</option>
                            <option value="medium" ${script.risk_level === 'medium' ? 'selected' : ''}>Medium</option>
                            <option value="high" ${script.risk_level === 'high' ? 'selected' : ''}>High</option>
                            <option value="critical" ${script.risk_level === 'critical' ? 'selected' : ''}>Critical</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="editApprovalNotes">Notes</label>
                        <textarea id="editApprovalNotes" rows="3">${script.approval_notes || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label for="editRejectionReason">Rejection Reason (if rejected)</label>
                        <textarea id="editRejectionReason" rows="2">${script.rejection_reason || ''}</textarea>
                    </div>

                    <div style="padding: 15px; background: #f8f9fa; border-radius: 4px;">
                        <h4 style="margin: 0 0 10px 0; color: #666;">Read-Only Information</h4>
                        <div class="info-grid">
                            <div class="info-label">ID:</div>
                            <div>${script.id}</div>
                            <div class="info-label">URL:</div>
                            <div style="word-break: break-all;">${escapeHtml(script.url)}</div>
                            <div class="info-label">Type:</div>
                            <div>${script.script_type}</div>
                            <div class="info-label">First Seen:</div>
                            <div>${new Date(script.first_seen).toLocaleString()}</div>
                            <div class="info-label">Last Seen:</div>
                            <div>${new Date(script.last_seen).toLocaleString()}</div>
                            <div class="info-label">Access Count:</div>
                            <div><strong style="color: #3498db;">${script.access_count || 0}</strong></div>
                            ${script.last_accessed ? `
                            <div class="info-label">Last Accessed:</div>
                            <div>${new Date(script.last_accessed).toLocaleString()}</div>
                            ` : ''}
                            ${script.script_type === 'inline' && script.script_position !== null && script.script_position !== undefined ? `
                            <div class="info-label">Script Position:</div>
                            <div>${script.script_position}</div>
                            ` : ''}
                            ${script.is_variation ? `
                            <div class="info-label">Variation:</div>
                            <div><span class="badge warning">Variation #${script.variation_number}</span> of Script #${script.parent_script_id}</div>
                            ` : ''}
                            ${script.approved_at ? `
                            <div class="info-label">Approved/Rejected At:</div>
                            <div>${new Date(script.approved_at).toLocaleString()}</div>
                            ` : ''}
                            ${script.approved_by ? `
                            <div class="info-label">Approved/Rejected By:</div>
                            <div>${script.approved_by}</div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            // Update buttons
            document.getElementById('editScriptBtn').style.display = 'none';
            document.getElementById('saveScriptBtn').style.display = 'inline-block';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
            document.getElementById('closeDetailsBtn').style.display = 'none';
        }

        async function saveScriptChanges() {
            if (!currentScriptDetails) return;

            const scriptId = currentScriptDetails.script.id;
            const updateData = {
                status: document.getElementById('editStatus').value,
                businessJustification: document.getElementById('editBusinessJustification').value,
                scriptPurpose: document.getElementById('editScriptPurpose').value,
                scriptOwner: document.getElementById('editScriptOwner').value,
                riskLevel: document.getElementById('editRiskLevel').value || null,
                approvalNotes: document.getElementById('editApprovalNotes').value,
                rejectionReason: document.getElementById('editRejectionReason').value
            };

            try {
                await apiCall(`/api/admin/scripts/${scriptId}/update`, {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });

                document.getElementById('scriptDetailsError').style.display = 'none';

                // Reload script details
                await showScriptDetails(scriptId);

                // Refresh the inventory table
                fetchInventory();

            } catch (err) {
                document.getElementById('scriptDetailsError').textContent = 'Failed to save changes: ' + err.message;
                document.getElementById('scriptDetailsError').style.display = 'block';
            }
        }

        function cancelEdit() {
            if (!currentScriptDetails) return;

            // Redisplay in view mode
            showScriptDetails(currentScriptDetails.script.id);
        }

        function closeScriptDetailsModal() {
            document.getElementById('scriptDetailsModal').classList.remove('active');
            isEditMode = false;
            currentScriptDetails = null;
        }

        async function submitApproval() {
            const businessJustification = document.getElementById('businessJustification').value;
            const scriptPurpose = document.getElementById('scriptPurpose').value;

            if (!businessJustification || !scriptPurpose) {
                showError('approvalError', 'Please fill in all required fields');
                return;
            }

            try {
                await apiCall(`/api/admin/scripts/${currentScript}/approve`, {
                    method: 'POST',
                    body: JSON.stringify({
                        businessJustification,
                        scriptPurpose,
                        scriptOwner: document.getElementById('scriptOwner').value,
                        riskLevel: document.getElementById('riskLevel').value || null,
                        approvalNotes: document.getElementById('approvalNotes').value
                    })
                });

                closeModal();
                loadData();
            } catch (err) {
                showError('approvalError', err.message);
            }
        }

        async function submitRejection() {
            const rejectionReason = document.getElementById('rejectionReason').value;

            if (!rejectionReason) {
                showError('rejectionError', 'Please provide a rejection reason');
                return;
            }

            try {
                await apiCall(`/api/admin/scripts/${currentScript}/reject`, {
                    method: 'POST',
                    body: JSON.stringify({
                        rejectionReason,
                        riskLevel: document.getElementById('rejectionRiskLevel').value || null,
                        notes: document.getElementById('rejectionNotes').value
                    })
                });

                closeModal();
                loadData();
            } catch (err) {
                showError('rejectionError', err.message);
            }
        }

        // Tab Management
        function showTab(tabName, clickedElement) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));

            // If called from onclick, use the clicked element; otherwise find the tab button
            if (clickedElement) {
                clickedElement.classList.add('active');
            } else {
                // Find the tab button by matching the onclick attribute
                const tabButtons = document.querySelectorAll('.tab');
                tabButtons.forEach(btn => {
                    if (btn.getAttribute('onclick')?.includes(`'${tabName}'`)) {
                        btn.classList.add('active');
                    }
                });
            }
            
            document.getElementById(tabName).classList.add('active');
        }

        // Utilities
        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.style.display = 'block';
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function loadData() {
            fetchDashboard();
            fetchPendingScripts();
            fetchViolations();
            fetchInventory();
            loadUsers();
            updateMfaStatus();
            updateAccountInfo();
        }

        // MFA Status and Management
        async function updateMfaStatus() {
            if (!currentUser) return;

            try {
                // Get current MFA status from user object or make API call
                const mfaEnabled = currentUser.mfa_enabled || false;

                const statusText = document.getElementById('mfaStatusText');
                const statusBadge = document.getElementById('mfaStatusBadge');
                const enableBtn = document.getElementById('enableMfaBtn');
                const disableBtn = document.getElementById('disableMfaBtn');

                if (mfaEnabled) {
                    statusText.textContent = 'Enabled';
                    statusText.style.color = '#27ae60';
                    statusBadge.innerHTML = '<span class="badge approved">Enabled</span>';
                    enableBtn.style.display = 'none';
                    disableBtn.style.display = 'inline-block';
                } else {
                    statusText.textContent = 'Disabled';
                    statusText.style.color = '#e74c3c';
                    statusBadge.innerHTML = '<span class="badge rejected">Disabled</span>';
                    enableBtn.style.display = 'inline-block';
                    disableBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error updating MFA status:', error);
            }
        }

        function updateAccountInfo() {
            if (!currentUser) return;

            document.getElementById('accountUsername').textContent = currentUser.username || '-';
            document.getElementById('accountEmail').textContent = currentUser.email || '-';
            document.getElementById('accountRole').textContent = currentUser.role || '-';
        }

        let mfaSetupData = null;

        async function startMfaSetup() {
            try {
                document.getElementById('mfaSetupError').style.display = 'none';
                document.getElementById('mfaSetupSuccess').style.display = 'none';

                // Show modal first (so elements are in DOM)
                document.getElementById('mfaSetupStep1').style.display = 'block';
                document.getElementById('mfaSetupStep2').style.display = 'none';
                document.getElementById('mfaSetupModal').classList.add('active');

                // Call API to generate MFA secret and QR code
                const data = await apiCall('/api/admin/auth/setup-mfa', {
                    method: 'POST',
                    body: JSON.stringify({ action: 'generate' })
                });

                mfaSetupData = data;

                // Now set QR code and secret (elements are visible)
                document.getElementById('mfaQrCode').src = data.qrCode;
                document.getElementById('mfaSecretKey').textContent = data.secret;
                document.getElementById('mfaVerificationCode').value = '';

                document.getElementById('mfaVerificationCode').focus();

            } catch (error) {
                console.error('MFA setup error:', error);
                document.getElementById('mfaSetupError').textContent = 'Failed to start MFA setup: ' + error.message;
                document.getElementById('mfaSetupError').style.display = 'block';
                // Close modal on error
                closeMfaSetupModal();
            }
        }

        async function verifyMfaSetup() {
            const verificationCode = document.getElementById('mfaVerificationCode').value.trim();

            if (!verificationCode || verificationCode.length !== 6) {
                document.getElementById('mfaSetupModalError').textContent = 'Please enter a valid 6-digit code';
                document.getElementById('mfaSetupModalError').style.display = 'block';
                return;
            }

            try {
                document.getElementById('mfaSetupModalError').style.display = 'none';

                // Verify and enable MFA
                const data = await apiCall('/api/admin/auth/setup-mfa', {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'verify',
                        verificationCode: verificationCode
                    })
                });

                // Update current user MFA status
                currentUser.mfa_enabled = true;
                localStorage.setItem('current_user', JSON.stringify(currentUser));

                // Show backup codes
                const backupCodesHtml = data.backupCodes.map(code =>
                    `<div style="padding: 8px; background: #fff; border: 1px solid #ddd; border-radius: 4px; text-align: center;">${code}</div>`
                ).join('');
                document.getElementById('backupCodesList').innerHTML = backupCodesHtml;

                // Show step 2 (backup codes)
                document.getElementById('mfaSetupStep1').style.display = 'none';
                document.getElementById('mfaSetupStep2').style.display = 'block';

                // Update status in main UI
                updateMfaStatus();

            } catch (error) {
                console.error('MFA verification error:', error);
                document.getElementById('mfaSetupModalError').textContent = 'Verification failed: ' + error.message;
                document.getElementById('mfaSetupModalError').style.display = 'block';
                document.getElementById('mfaVerificationCode').value = '';
            }
        }

        function copyBackupCodes() {
            const codes = document.getElementById('backupCodesList').innerText;
            navigator.clipboard.writeText(codes).then(() => {
                alert('Backup codes copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        function closeMfaSetupModal() {
            document.getElementById('mfaSetupModal').classList.remove('active');
            document.getElementById('mfaSetupStep1').style.display = 'none';
            document.getElementById('mfaSetupStep2').style.display = 'none';
            document.getElementById('mfaSetupModalError').style.display = 'none';
            mfaSetupData = null;
        }

        async function disableMfa() {
            const verificationCode = prompt('To disable MFA, please enter a verification code from your authenticator app:');
            if (!verificationCode) {
                return;
            }

            if (!confirm('Are you sure you want to disable Two-Factor Authentication? This will make your account less secure.')) {
                return;
            }

            try {
                await apiCall('/api/admin/auth/setup-mfa', {
                    method: 'POST',
                    body: JSON.stringify({ action: 'disable', verificationCode: verificationCode })
                });

                // Update current user MFA status
                currentUser.mfa_enabled = false;
                localStorage.setItem('current_user', JSON.stringify(currentUser));

                // Update status
                updateMfaStatus();

                document.getElementById('mfaSetupSuccess').textContent = 'Two-Factor Authentication has been disabled.';
                document.getElementById('mfaSetupSuccess').style.display = 'block';

                setTimeout(() => {
                    document.getElementById('mfaSetupSuccess').style.display = 'none';
                }, 5000);

            } catch (error) {
                console.error('MFA disable error:', error);
                document.getElementById('mfaSetupError').textContent = 'Failed to disable MFA: ' + error.message;
                document.getElementById('mfaSetupError').style.display = 'block';
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (authToken) {
                loadData();
            }
        }, 30000);

        // Check if already logged in on page load
        if (authToken && refreshToken) {
            // Try to restore session from localStorage
            const savedUser = localStorage.getItem('current_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                } catch (e) {
                    console.error('Failed to parse saved user:', e);
                }
            }

            // Test the token and show dashboard if valid
            fetchDashboard().then(() => {
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';
                loadData();
                console.log('Session restored for:', currentUser?.username || 'unknown user');
            }).catch(err => {
                // Token expired or invalid - try to refresh
                refreshAccessToken().then(refreshed => {
                    if (refreshed) {
                        // Retry loading dashboard with new token
                        fetchDashboard().then(() => {
                            document.getElementById('authSection').style.display = 'none';
                            document.getElementById('mainDashboard').style.display = 'block';
                            loadData();
                        }).catch(() => {
                            // Still failed, clear and show login
                            logout();
                        });
                    } else {
                        // Refresh failed, show login
                        logout();
                    }
                }).catch(() => {
                    logout();
                });
            });
        }

        document.getElementById('loginButton').addEventListener('click', login);

        // ============================================================================
        // USER MANAGEMENT FUNCTIONS
        // ============================================================================

        let currentEditingUserId = null;

        /**
         * Load and display all users
         */
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users', {
                    headers: {
                        'X-API-Token': authToken
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        handleTokenExpiration();
                        return;
                    }
                    throw new Error('Failed to load users');
                }

                const data = await response.json();
                const users = data.data || [];

                displayUsers(users);
            } catch (error) {
                console.error('[Users] Error loading users:', error);
                document.getElementById('usersContent').innerHTML = `
                    <div class="error-message" style="display: block;">
                        Failed to load users: ${error.message}
                    </div>
                `;
            }
        }

        /**
         * Display users in a table
         */
        function displayUsers(users) {
            const container = document.getElementById('usersContent');

            if (users.length === 0) {
                container.innerHTML = '<p style="color: #7f8c8d;">No users found.</p>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            users.forEach(user => {
                const isActive = user.is_active === 1 || user.is_active === true;
                const statusBadge = isActive
                    ? '<span class="status-badge approved">Active</span>'
                    : '<span class="status-badge rejected">Inactive</span>';

                const roleBadge = {
                    'super_admin': '<span class="status-badge" style="background: #9b59b6;">Super Admin</span>',
                    'admin': '<span class="status-badge" style="background: #3498db;">Admin</span>',
                    'reviewer': '<span class="status-badge" style="background: #2ecc71;">Reviewer</span>',
                    'viewer': '<span class="status-badge" style="background: #95a5a6;">Viewer</span>'
                }[user.role] || user.role;

                const createdDate = new Date(user.created_at).toLocaleDateString();
                const lastLogin = user.last_login_at ? new Date(user.last_login_at).toLocaleString() : 'Never';

                const isCurrentUser = currentUser && (currentUser.id === user.id || currentUser.username === user.username);
                const canModify = !isCurrentUser; // Can't modify own account

                html += `
                    <tr>
                        <td>${user.id}</td>
                        <td><strong>${escapeHtml(user.username)}</strong></td>
                        <td>${escapeHtml(user.email)}</td>
                        <td>${roleBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${createdDate}</td>
                        <td style="font-size: 12px;">${lastLogin}</td>
                        <td>
                            ${canModify ? `
                                <button class="small secondary" onclick="editUser(${user.id})" title="Edit User">
                                    ✏️ Edit
                                </button>
                                ${isActive ? `
                                    <button class="small danger" onclick="toggleUserStatus(${user.id}, false)" title="Disable User">
                                        🚫 Disable
                                    </button>
                                ` : `
                                    <button class="small success" onclick="toggleUserStatus(${user.id}, true)" title="Enable User">
                                        ✅ Enable
                                    </button>
                                `}
                                <button class="small danger" onclick="confirmDeleteUser(${user.id}, '${escapeHtml(user.username)}')" title="Delete User">
                                    🗑️ Delete
                                </button>
                            ` : '<span style="color: #95a5a6; font-size: 12px;">(Current User)</span>'}
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        /**
         * Open user modal for adding a new user
         */
        function openUserModal() {
            currentEditingUserId = null;
            document.getElementById('userModalTitle').textContent = 'Add New User';
            document.getElementById('userUsername').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = true;
            document.getElementById('userPassword').parentElement.querySelector('label').textContent = 'Password *';
            document.getElementById('userRole').value = 'reviewer';
            document.getElementById('userIsActive').value = '1';
            document.getElementById('userError').style.display = 'none';
            document.getElementById('userModal').style.display = 'flex';
        }

        /**
         * Edit an existing user
         */
        async function editUser(userId) {
            try {
                const response = await fetch('/api/admin/users', {
                    headers: {
                        'X-API-Token': authToken
                    }
                });

                if (!response.ok) throw new Error('Failed to load user data');

                const data = await response.json();
                const user = (data.data || []).find(u => u.id === userId);

                if (!user) {
                    alert('User not found');
                    return;
                }

                currentEditingUserId = userId;
                document.getElementById('userModalTitle').textContent = 'Edit User';
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userPassword').value = '';
                document.getElementById('userPassword').required = false;
                document.getElementById('userPassword').parentElement.querySelector('label').textContent = 'Password (leave blank to keep unchanged)';
                document.getElementById('userRole').value = user.role;
                document.getElementById('userIsActive').value = user.is_active ? '1' : '0';
                document.getElementById('userError').style.display = 'none';
                document.getElementById('userModal').style.display = 'flex';
            } catch (error) {
                console.error('[Users] Error loading user for edit:', error);
                alert('Failed to load user data: ' + error.message);
            }
        }

        /**
         * Save user (create or update)
         */
        async function saveUser() {
            const username = document.getElementById('userUsername').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;
            const is_active = parseInt(document.getElementById('userIsActive').value);

            // Validation
            if (!username || !email) {
                showUserError('Username and email are required');
                return;
            }

            if (!currentEditingUserId && !password) {
                showUserError('Password is required for new users');
                return;
            }

            const userData = {
                username,
                email,
                role,
                is_active
            };

            if (password) {
                userData.password = password;
            }

            try {
                const url = currentEditingUserId
                    ? `/api/admin/users/${currentEditingUserId}`
                    : '/api/admin/users';

                const method = currentEditingUserId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Token': authToken
                    },
                    body: JSON.stringify(userData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save user');
                }

                closeUserModal();
                loadUsers();

                const action = currentEditingUserId ? 'updated' : 'created';
                alert(`User ${action} successfully`);
            } catch (error) {
                console.error('[Users] Error saving user:', error);
                showUserError(error.message);
            }
        }

        /**
         * Toggle user status (enable/disable)
         */
        async function toggleUserStatus(userId, enable) {
            const action = enable ? 'enable' : 'disable';

            if (!confirm(`Are you sure you want to ${action} this user?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Token': authToken
                    },
                    body: JSON.stringify({
                        is_active: enable ? 1 : 0
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Failed to ${action} user`);
                }

                loadUsers();
                alert(`User ${enable ? 'enabled' : 'disabled'} successfully`);
            } catch (error) {
                console.error(`[Users] Error ${action}ing user:`, error);
                alert(`Failed to ${action} user: ${error.message}`);
            }
        }

        /**
         * Confirm and delete a user
         */
        function confirmDeleteUser(userId, username) {
            if (!confirm(`Are you sure you want to DELETE user "${username}"?\n\nThis action cannot be undone!`)) {
                return;
            }

            deleteUserById(userId);
        }

        /**
         * Delete a user by ID
         */
        async function deleteUserById(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-API-Token': authToken
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete user');
                }

                loadUsers();
                alert('User deleted successfully');
            } catch (error) {
                console.error('[Users] Error deleting user:', error);
                alert('Failed to delete user: ' + error.message);
            }
        }

        /**
         * Close user modal
         */
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            currentEditingUserId = null;
        }

        /**
         * Show error in user modal
         */
        function showUserError(message) {
            const errorDiv = document.getElementById('userError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        /**
         * HTML escape helper
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Add click outside to close modals
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                const modals = ['approvalModal', 'rejectionModal', 'detailsModal', 'userModal', 'mfaSetupModal'];
                modals.forEach(modalId => {
                    if (event.target.id === modalId) {
                        document.getElementById(modalId).style.display = 'none';
                    }
                });
            }
        };

    </script>
</body>
</html>
