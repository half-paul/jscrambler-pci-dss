<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Page - PCI DSS 6.4.3 Compliant</title>

  <!--
    CRITICAL: Script Integrity Monitor must load FIRST
    This ensures all subsequent scripts are monitored
  -->

  <!-- 1. Load configuration FIRST -->
  <script src="script-integrity-config.js"></script>

  <!-- 2. Load monitor SECOND (before any other scripts) -->
  <script src="script-integrity-monitor.js"></script>

  <!--
    Now load other scripts - they will all be monitored
    Include SRI attributes for external scripts (best practice)
  -->

  <!-- Example: jQuery from CDN with SRI -->
  <script
    src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha384-1H217gwSVyLSIfaLxHbE7dRb3v4mYCKbpQvzx0cegeju1MVsGrX5xXxAvs/HgeFs"
    crossorigin="anonymous"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
    }
    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      width: 100%;
      padding: 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .security-notice {
      margin-top: 20px;
      padding: 15px;
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      border-radius: 4px;
    }
    .security-notice h3 {
      margin: 0 0 10px 0;
      color: #2e7d32;
      font-size: 14px;
    }
    .security-notice p {
      margin: 0;
      color: #555;
      font-size: 12px;
      line-height: 1.5;
    }
    .status {
      margin-top: 20px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 12px;
      font-family: monospace;
    }
    .status-item {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #007bff;
      background: white;
    }
    .status-item.ok {
      border-left-color: #4caf50;
    }
    .status-item.warning {
      border-left-color: #ff9800;
    }
    .status-item.error {
      border-left-color: #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Secure Payment</h1>

    <form id="paymentForm">
      <div class="form-group">
        <label for="cardNumber">Card Number</label>
        <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" required>
      </div>

      <div class="form-group">
        <label for="cardName">Cardholder Name</label>
        <input type="text" id="cardName" placeholder="John Doe" required>
      </div>

      <div class="form-group">
        <label for="expiryDate">Expiry Date</label>
        <input type="text" id="expiryDate" placeholder="MM/YY" required>
      </div>

      <div class="form-group">
        <label for="cvv">CVV</label>
        <input type="text" id="cvv" placeholder="123" maxlength="4" required>
      </div>

      <button type="submit">Process Payment</button>
    </form>

    <div class="security-notice">
      <h3>Security Notice</h3>
      <p>
        This page is protected by Script Integrity Monitoring (PCI DSS 6.4.3 compliant).
        All scripts are verified for integrity using cryptographic hashes.
        Any unauthorized scripts will be detected and blocked.
      </p>
    </div>

    <div class="status" id="statusPanel">
      <strong>Script Integrity Status:</strong>
      <div id="statusContent">Loading...</div>
    </div>
  </div>

  <!-- Inline script: Payment form handler -->
  <script>
    // Payment form handling
    document.getElementById('paymentForm').addEventListener('submit', function(e) {
      e.preventDefault();

      // Validate inputs
      const cardNumber = document.getElementById('cardNumber').value;
      const cardName = document.getElementById('cardName').value;
      const expiryDate = document.getElementById('expiryDate').value;
      const cvv = document.getElementById('cvv').value;

      if (!cardNumber || !cardName || !expiryDate || !cvv) {
        alert('Please fill in all fields');
        return;
      }

      // In production, send to payment processor
      console.log('Processing payment...');
      alert('Payment processing (demo mode)');

      // Generate compliance report
      const report = window.ScriptIntegrityMonitor.generateReport();
      console.log('Payment processed with script integrity verification:', report);
      console.log('Console log added again:', report);
    });
  </script>

  <!-- Inline script: Status display -->
  <script>
    // Wait for page to fully load
    window.addEventListener('load', function() {
      // Give monitor time to process all scripts (async operations)
      setTimeout(function() {
        displayScriptIntegrityStatus();
      }, 1500);
    });

    function displayScriptIntegrityStatus() {
      const statusContent = document.getElementById('statusContent');

      if (!window.ScriptIntegrityMonitor) {
        statusContent.innerHTML = '<div class="status-item error">Script Integrity Monitor not loaded</div>';
        return;
      }

      const summary = window.ScriptIntegrityMonitor.getSummary();
      // Only get actual security violations (exclude PENDING_APPROVAL and NEW_SCRIPT)
      const violations = window.ScriptIntegrityMonitor.getViolations(false);

      // Check for blocked scripts
      const allViolations = window.ScriptIntegrityMonitor.getViolations(true);
      const blockedScripts = allViolations.filter(v => v.violationType === 'REJECTED_BY_ADMIN');

      let html = '';

      // Overall status - use unauthorizedScripts from summary which correctly filters out pending/new scripts
      if (summary.unauthorizedScripts === 0) {
        html += '<div class="status-item ok">‚úì All scripts authorized (' + summary.totalScripts + ' scripts)</div>';
      } else {
        html += '<div class="status-item error">‚úó ' + summary.unauthorizedScripts + ' unauthorized script(s) detected</div>';
      }

      // Show blocked scripts prominently if any exist
      if (blockedScripts.length > 0) {
        html += '<div class="status-item error">üö´ ' + blockedScripts.length + ' script(s) BLOCKED by administrator</div>';
      }

      // Script counts
      html += '<div class="status-item ok">‚Ä¢ External scripts: ' + summary.externalScripts + '</div>';
      html += '<div class="status-item ok">‚Ä¢ Inline scripts: ' + summary.inlineScripts + '</div>';
      html += '<div class="status-item ok">‚Ä¢ Authorized: ' + summary.authorizedScripts + '</div>';

      if (summary.unauthorizedScripts > 0) {
        html += '<div class="status-item error">‚Ä¢ Unauthorized: ' + summary.unauthorizedScripts + '</div>';
      }

      // Monitoring info
      const config = window.SCRIPT_INTEGRITY_CONFIG;
      html += '<div class="status-item ok">‚Ä¢ Mode: ' + config.mode + '</div>';
      html += '<div class="status-item ok">‚Ä¢ Algorithm: ' + config.hashAlgorithm + '</div>';

      // Show blocked script details if any
      if (blockedScripts.length > 0) {
        html += '<div class="status-item error" style="margin-top: 10px;"><strong>Blocked Scripts:</strong></div>';
        blockedScripts.forEach(function(v) {
          const scriptName = v.src || v.scriptId || 'inline script';
          html += '<div class="status-item error" style="margin-left: 20px; font-size: 11px;">‚ùå ' + scriptName + '</div>';
        });
      }

      statusContent.innerHTML = html;

      // Log detailed report to console
      console.log('=== Script Integrity Report ===');
      console.log('Summary:', summary);
      console.log('Inventory:', window.ScriptIntegrityMonitor.getInventory());
      if (violations.length > 0) {
        console.error('Security Violations:', violations);
      }
      // Also show pending/new scripts separately (for informational purposes)
      const allViolations = window.ScriptIntegrityMonitor.getViolations(true);
      const pendingScripts = allViolations.filter(v => 
        v.violationType === 'PENDING_APPROVAL' || v.violationType === 'NEW_SCRIPT'
      );
      if (pendingScripts.length > 0) {
        console.info('Pending/New Scripts (not security violations):', pendingScripts);
      }
      console.log('Full Report:', window.ScriptIntegrityMonitor.generateReport());
    }

    // Test: Add a button to dynamically load a script (for testing)
    function addTestScript() {
      const script = document.createElement('script');
      script.textContent = 'console.log("Dynamically added test script");';
      document.body.appendChild(script);

      setTimeout(function() {
        displayScriptIntegrityStatus();
      }, 500);
    }

    // Expose for testing
    window.testDynamicScript = addTestScript;
  </script>

  <!-- Example: Test dynamic script loading -->
  <!-- Uncomment to test violation detection:
  <script>
    setTimeout(function() {
      // This will be detected as unauthorized if not in baseline
      const script = document.createElement('script');
      script.src = 'https://example.com/unauthorized-script.js';
      document.head.appendChild(script);
    }, 2000);
  </script>
  -->
</body>
</html>
