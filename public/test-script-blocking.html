<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Script Blocking Test - Enforcement Mode</title>

  <!-- Test Page Navigation -->
  <script src="test-navigation.js"></script>

  <!-- Load configuration FIRST - set to ENFORCE mode -->
  <script>
    window.SCRIPT_INTEGRITY_CONFIG = {
      hashAlgorithm: 'SHA-384',
      mode: 'enforce',  // ENFORCE MODE - will block rejected scripts
      baselineHashes: {},
      whitelistedSources: [],
      debug: true,
      consoleAlerts: true,
      monitorInlineScripts: true,
      monitorExternalScripts: true,
      monitorDynamicScripts: true,

      // Server integration
      serverBaseUrl: (function() {
        if (window.location.hostname === 'localhost' ||
            window.location.hostname === '127.0.0.1' ||
            window.location.port === '3000') {
          return window.location.origin;
        }
        return null;
      })(),
      registerScriptEndpoint: '/api/scripts/register',
      checkStatusEndpoint: '/api/scripts/status',
      reportViolationEndpoint: '/api/scripts/violation',
      autoRegisterNewScripts: true,
      pollApprovalStatus: true,
      pollInterval: 5000,
      pollTimeout: 60000,
      fallbackMode: 'report'
    };
  </script>

  <!-- Load monitor SECOND -->
  <script src="script-integrity-monitor.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #d32f2f;
      margin-bottom: 10px;
    }
    .warning {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }
    .status {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 14px;
    }
    .status-item {
      margin: 8px 0;
      padding: 8px;
      border-left: 3px solid #007bff;
      background: white;
    }
    .status-item.ok {
      border-left-color: #4caf50;
    }
    .status-item.error {
      border-left-color: #f44336;
      background: #ffebee;
    }
    button {
      padding: 12px 20px;
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 10px 5px 10px 0;
    }
    button:hover {
      background: #b71c1c;
    }
    button.refresh {
      background: #1976d2;
    }
    button.refresh:hover {
      background: #0d47a1;
    }
    .instructions {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .instructions h3 {
      margin-top: 0;
      color: #1565c0;
    }
    .instructions ol {
      margin: 10px 0;
      padding-left: 20px;
    }
    .instructions li {
      margin: 8px 0;
    }
    .blocked-indicator {
      background: #d32f2f;
      color: white;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üö´ Script Blocking Test</h1>
    <p><strong>Enforcement Mode Active</strong> - Rejected scripts will be blocked</p>

    <div class="warning">
      <strong>‚ö†Ô∏è Warning:</strong> This page is in ENFORCEMENT mode. Scripts rejected by administrators will be actively blocked from executing.
    </div>

    <div class="instructions">
      <h3>üìã Testing Instructions</h3>
      <ol>
        <li><strong>Wait 5-10 seconds</strong> for scripts to register with the server</li>
        <li><strong>Open Admin Panel</strong> in a new tab: <a href="/admin-panel.html" target="_blank">Admin Panel</a></li>
        <li><strong>Go to "Pending Approvals"</strong> tab</li>
        <li><strong>Reject one or more scripts</strong> (click ‚ùå Reject button)</li>
        <li><strong>Come back to this page</strong> and wait 5-10 seconds</li>
        <li><strong>Click "Refresh Status"</strong> to see the blocked scripts</li>
        <li><strong>Try to add the rejected script again</strong> using the button below</li>
      </ol>
    </div>

    <div>
      <button class="refresh" onclick="refreshStatus()">üîÑ Refresh Status</button>
      <button onclick="addTestScript()">‚ûï Add Test Script (will be blocked if rejected)</button>
      <button onclick="viewConsole()">üìä View Console Logs</button>
    </div>

    <div class="status" id="statusPanel">
      <strong>Script Integrity Status:</strong>
      <div id="statusContent">Loading...</div>
    </div>

    <div id="blockedIndicator" style="display:none;" class="blocked-indicator">
      üö´ BLOCKED SCRIPTS DETECTED - See details below
    </div>
  </div>

  <!-- Test inline script that will be detected -->
  <script>
    console.log('Test inline script #1 - This script will be detected and sent for approval');

    function displayScriptIntegrityStatus() {
      const statusContent = document.getElementById('statusContent');
      const blockedIndicator = document.getElementById('blockedIndicator');

      if (!window.ScriptIntegrityMonitor) {
        statusContent.innerHTML = '<div class="status-item error">Script Integrity Monitor not loaded</div>';
        return;
      }

      const summary = window.ScriptIntegrityMonitor.getSummary();
      const violations = window.ScriptIntegrityMonitor.getViolations(false);
      const allViolations = window.ScriptIntegrityMonitor.getViolations(true);
      const blockedScripts = allViolations.filter(v => v.violationType === 'REJECTED_BY_ADMIN');
      const pendingScripts = allViolations.filter(v => v.violationType === 'PENDING_APPROVAL' || v.violationType === 'NEW_SCRIPT');

      let html = '';

      // Overall status
      if (summary.unauthorizedScripts === 0 && blockedScripts.length === 0) {
        html += '<div class="status-item ok">‚úì All scripts authorized (' + summary.totalScripts + ' scripts)</div>';
      } else {
        if (summary.unauthorizedScripts > 0) {
          html += '<div class="status-item error">‚úó ' + summary.unauthorizedScripts + ' unauthorized script(s)</div>';
        }
        if (blockedScripts.length > 0) {
          html += '<div class="status-item error">üö´ ' + blockedScripts.length + ' script(s) BLOCKED by administrator</div>';
          blockedIndicator.style.display = 'block';
        }
      }

      // Script counts
      html += '<div class="status-item ok">‚Ä¢ Total scripts detected: ' + summary.totalScripts + '</div>';
      html += '<div class="status-item ok">‚Ä¢ Authorized: ' + summary.authorizedScripts + '</div>';

      if (pendingScripts.length > 0) {
        html += '<div class="status-item" style="border-left-color: #ff9800;">‚Ä¢ Pending approval: ' + pendingScripts.length + '</div>';
      }

      if (blockedScripts.length > 0) {
        html += '<div class="status-item error">‚Ä¢ Blocked (rejected): ' + blockedScripts.length + '</div>';
      }

      // Monitoring info
      const config = window.SCRIPT_INTEGRITY_CONFIG;
      html += '<div class="status-item" style="border-left-color: #d32f2f;"><strong>‚Ä¢ Mode: ' + config.mode.toUpperCase() + '</strong></div>';
      html += '<div class="status-item ok">‚Ä¢ Algorithm: ' + config.hashAlgorithm + '</div>';

      // Show blocked script details
      if (blockedScripts.length > 0) {
        html += '<div class="status-item error" style="margin-top: 15px; font-weight: bold;">üö´ BLOCKED SCRIPTS:</div>';
        blockedScripts.forEach(function(v) {
          const scriptName = v.src || v.scriptId || 'inline script';
          const timestamp = new Date(v.timestamp).toLocaleTimeString();
          html += '<div class="status-item error" style="margin-left: 20px; font-size: 12px;">';
          html += '‚ùå ' + scriptName + '<br>';
          html += '<span style="color: #666;">Blocked at: ' + timestamp + '</span>';
          html += '</div>';
        });
      }

      // Show pending scripts
      if (pendingScripts.length > 0) {
        html += '<div class="status-item" style="margin-top: 15px; border-left-color: #ff9800;"><strong>‚è≥ Pending Approval:</strong></div>';
        pendingScripts.forEach(function(v) {
          const scriptName = v.src || v.scriptId || 'inline script';
          html += '<div class="status-item" style="margin-left: 20px; font-size: 12px; border-left-color: #ff9800;">';
          html += '‚è≥ ' + scriptName;
          html += '</div>';
        });
      }

      statusContent.innerHTML = html;

      // Log to console
      console.log('=== Script Blocking Test Status ===');
      console.log('Summary:', summary);
      console.log('Blocked Scripts:', blockedScripts);
      console.log('Pending Scripts:', pendingScripts);
      console.log('All Violations:', allViolations);
    }

    function refreshStatus() {
      console.log('Refreshing status...');
      displayScriptIntegrityStatus();
    }

    function addTestScript() {
      console.log('Adding test script...');
      const script = document.createElement('script');
      script.textContent = 'console.log("Dynamic test script - ' + Date.now() + '");';
      document.body.appendChild(script);

      setTimeout(function() {
        refreshStatus();
        console.log('‚úÖ Test script added. If it was previously rejected, it should be blocked.');
      }, 1000);
    }

    function viewConsole() {
      console.log('%c=== SCRIPT INTEGRITY MONITOR - BLOCKING TEST ===', 'background: #d32f2f; color: white; font-weight: bold; padding: 10px;');
      console.log('Full Inventory:', window.ScriptIntegrityMonitor.getInventory());
      console.log('All Violations:', window.ScriptIntegrityMonitor.getViolations(true));
      console.log('Security Violations Only:', window.ScriptIntegrityMonitor.getViolations(false));
      console.log('Full Report:', window.ScriptIntegrityMonitor.generateReport());
      alert('üìä Check the browser console for detailed logs');
    }

    // Auto-refresh status every 10 seconds
    setInterval(refreshStatus, 10000);

    // Initial status display
    window.addEventListener('load', function() {
      setTimeout(displayScriptIntegrityStatus, 1000);
    });
  </script>

  <!-- Another inline script for testing -->
  <script>
    console.log('Test inline script #2 - This is another script that will be detected');
  </script>
</body>
</html>
